# EDS Calendar Sync

> **Here be dragons.** This code was generated by Claude (Anthropic's AI) to scratch a specific personal itch. It is not a supported project — there are no guarantees, no SLA, no warranty, and no promise that it will work for your setup. It does what it does. Use it, adapt it, or ignore it entirely — at your own risk.

A Python utility for bidirectional synchronization of calendar events between work and personal calendars via Evolution Data Server (EDS). The tool strips sensitive information while preserving availability blocking, with flexible sync directions and safety features.

## Features

- **Bidirectional Sync (Default)**: Two-way synchronization between work and personal calendars
- **One-Way Modes**: Optional work→personal or personal→work sync only
- **Privacy-First**: Strips sensitive data (descriptions, attendees, locations, organizers)
- **Flexible Sanitization**:
  - Work→Personal: Keeps event titles, strips details
  - Personal→Work: Replaces title with "Busy", strips everything
- **State Tracking**: SQLite database for efficient change detection
- **Metadata Tagging**: Events marked with CATEGORY for identification
- **Smart Features**:
  - Confirmation prompt before sync (bypass with `--yes`)
  - Human-readable calendar names in output
  - Dry-run mode to preview changes
  - Refresh mode to resync everything
  - Clear mode to remove all synced events
- **Systemd Integration**: Run as a periodic timer service
- **Configurable**: Command-line args or config file support
- **GNOME/Fedora Native**: Uses EDS (Evolution Data Server) for reliable access

## Design Rationale

This tool solves specific pain points with Microsoft 365 Exchange and Google Calendar:

1. **UID Rewriting**: Microsoft 365 rewrites event UIDs, breaking traditional sync tools
2. **Organizer Restrictions**: CalDAV services reject events where you're not the organizer
3. **Privacy Concerns**: Work calendar details shouldn't leak to personal calendars (and vice versa)
4. **Local Cache**: EDS provides a stable local cache that syncs independently
5. **Bidirectional Need**: Block personal events in work calendar as "Busy" while showing work events with titles in personal calendar

## Requirements

- **Operating System**: Fedora (or any Linux with GNOME)
- **Python**: 3.9+
- **System Libraries**:
  - `evolution-data-server` (usually pre-installed with GNOME)
  - `python3-gobject` (PyGObject)
- **Accounts Configured**:
  - Work calendar synced via Evolution/GNOME Calendar (Exchange/Outlook)
  - Personal calendar synced via Evolution/GNOME Calendar (Google)

### Installation

```bash
# Install Python dependencies (usually already available on Fedora)
sudo dnf install python3-gobject evolution-data-server

# Make scripts executable
chmod +x eds-calendar-sync.py list-calendars.py

# Copy to user bin directory (optional)
mkdir -p ~/.local/bin
cp eds-calendar-sync.py ~/.local/bin/
cp list-calendars.py ~/.local/bin/
```

## Configuration

### Step 1: Find Your Calendar UIDs

```bash
./list-calendars.py
```

This will display all calendars available in EDS with their UIDs. Identify your:
- **Work calendar** (Outlook/Exchange): Usually the Exchange/Microsoft 365 calendar
- **Personal calendar** (Google): Usually your personal Google calendar

### Step 2: Create Configuration File (Optional)

```bash
# Copy example config
mkdir -p ~/.config
cp eds-calendar-sync.conf.example ~/.config/eds-calendar-sync.conf

# Edit with your calendar UIDs
nano ~/.config/eds-calendar-sync.conf
```

**Example configuration:**
```ini
[calendar-sync]
work_calendar_id = d19280dcbb91f8ebcdbbb2adb7d502bc1d866fda
personal_calendar_id = 02e0b7e48f4e0dbfb2c91861a8e184a75617e193
```

## Usage

### Interactive First-Time Sync (Recommended)

The tool shows calendar names and asks for confirmation before syncing:

```bash
# Dry run to preview (no confirmation needed)
./eds-calendar-sync.py \
  --work-calendar d19280dcbb91f8ebcdbbb2adb7d502bc1d866fda \
  --personal-calendar 02e0b7e48f4e0dbfb2c91861a8e184a75617e193 \
  --dry-run

# Actual sync (will prompt for confirmation)
./eds-calendar-sync.py \
  --work-calendar d19280dcbb91f8ebcdbbb2adb7d502bc1d866fda \
  --personal-calendar 02e0b7e48f4e0dbfb2c91861a8e184a75617e193
```

**Output example:**
```
============================================================
EDS Calendar Sync
============================================================
Work Calendar:     Company Calendar (work.user@company.com)
                   UID: d19280dcbb91f8ebcdbbb2adb7d502bc1d866fda
Personal Calendar: Personal Calendar (personal.user@gmail.com)
                   UID: 05a8819b2547ba3bbc244fdd3d135121ade11525
State Database:    /home/user/.local/share/eds-calendar-sync-state.db
Sync Direction:    BIDIRECTIONAL (work ↔ personal)
Mode:              LIVE
============================================================
Proceed with sync? [y/N]:
```

### Sync Modes

#### Bidirectional Sync (Default)
Syncs both directions: work ↔ personal

```bash
# Interactive (prompts for confirmation)
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID

# Non-interactive (auto-confirm)
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID --yes
```

#### One-Way Sync: Work → Personal Only
```bash
./eds-calendar-sync.py \
  --work-calendar WORK_UID \
  --personal-calendar PERSONAL_UID \
  --only-to-personal --yes
```

Work events appear in personal calendar with titles and details (sanitized).

#### One-Way Sync: Personal → Work Only
```bash
./eds-calendar-sync.py \
  --work-calendar WORK_UID \
  --personal-calendar PERSONAL_UID \
  --only-to-work --yes
```

Personal events appear in work calendar as "Busy" (maximum privacy).

### Special Operations

#### Dry Run (Preview Changes)
```bash
# Shows what would happen without making changes
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID --dry-run
```

Dry-run mode automatically skips confirmation prompt.

#### Refresh (Resync Everything)
```bash
# Remove all synced events and resync from scratch
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID --refresh --yes
```

**Important**: `--refresh` respects sync direction:
- Bidirectional: Removes synced events from BOTH calendars
- `--only-to-personal`: Removes only from personal calendar
- `--only-to-work`: Removes only from work calendar

Original (non-synced) events are always preserved.

#### Clear (Remove All Synced Events)
```bash
# Remove all events created by this tool (no resync)
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID --clear --yes
```

Like `--refresh` but without resyncing. Also respects sync direction.

### Configuration File Usage

If you created `~/.config/eds-calendar-sync.conf`:

```bash
# Uses config file
./eds-calendar-sync.py

# With options
./eds-calendar-sync.py --dry-run
./eds-calendar-sync.py --only-to-personal --yes
./eds-calendar-sync.py --refresh --yes
```

### Command-Line Options

```
--work-calendar WORK_UID      Work calendar UID (required)
--personal-calendar PERS_UID  Personal calendar UID (required)
--config CONFIG               Config file path (default: ~/.config/eds-calendar-sync.conf)
--state-db PATH               State database path (default: ~/.local/share/eds-calendar-sync-state.db)

Sync Direction (mutually exclusive):
--only-to-personal            Sync work → personal only (default is bidirectional)
--only-to-work                Sync personal → work only (default is bidirectional)

Modes:
--dry-run                     Preview changes without applying them
--refresh                     Remove synced events and resync (respects direction)
--clear                       Remove all synced events without resyncing

Options:
--yes, -y                     Auto-confirm without prompting (required for automation)
--verbose, -v                 Enable verbose debug output
```

## Systemd Timer Setup

To run the sync automatically every 15 minutes:

### 1. Install Service Files

```bash
# Create systemd user directory
mkdir -p ~/.config/systemd/user

# Copy service files
cp systemd/eds-calendar-sync.service ~/.config/systemd/user/
cp systemd/eds-calendar-sync.timer ~/.config/systemd/user/

# Edit service file to:
# 1. Point to your script location
# 2. Add --yes flag (required for automation)
# 3. Set your calendar UIDs or use config file
nano ~/.config/systemd/user/eds-calendar-sync.service
```

**Important**: Add `--yes` flag to ExecStart line for automation:
```ini
ExecStart=/path/to/eds-calendar-sync.py --work-calendar UID --personal-calendar UID --yes
```

### 2. Enable and Start Timer

```bash
# Reload systemd user daemon
systemctl --user daemon-reload

# Enable timer to start on boot
systemctl --user enable eds-calendar-sync.timer

# Start timer immediately
systemctl --user start eds-calendar-sync.timer

# Check timer status
systemctl --user status eds-calendar-sync.timer

# View timer schedule
systemctl --user list-timers
```

### 3. Monitor Sync Logs

```bash
# View recent logs
journalctl --user -u eds-calendar-sync.service -n 50

# Follow logs in real-time
journalctl --user -u eds-calendar-sync.service -f

# Check when last run occurred
systemctl --user status eds-calendar-sync.service
```

### 4. Manual Trigger

```bash
# Manually trigger a sync without waiting for timer
systemctl --user start eds-calendar-sync.service
```

### 5. Disable Timer

```bash
# Stop and disable the timer
systemctl --user stop eds-calendar-sync.timer
systemctl --user disable eds-calendar-sync.timer
```

## What Gets Synced

### Work → Personal Sanitization
Events synced from work to personal calendar:

**Retained Properties:**
- **SUMMARY**: Event title/subject (preserved)
- **DTSTART**: Start date/time
- **DTEND**: End date/time
- **RRULE**: Recurrence rules
- **EXDATE**: Recurrence exceptions
- **RDATE**: Additional recurrence dates

**Stripped Properties:**
- **DESCRIPTION**: Meeting details/notes
- **LOCATION**: Meeting location/room
- **ORGANIZER**: Meeting organizer (prevents CalDAV errors)
- **ATTENDEE**: All attendees (prevents phantom emails)
- **ATTACH**: File attachments
- **URL**: Meeting links
- **VALARM**: Alarms/reminders (prevents duplicate notifications)
- **CATEGORIES**: Original categories (replaced with sync marker)
- **RECURRENCE-ID**: Occurrence marker (makes exceptions standalone events)
- **STATUS**: Meeting status (prevents Exchange treating events as responses)
- **X-* properties**: All vendor extensions (e.g. `X-MS-OLK-*`, `X-MICROSOFT-CDO-*`) that reference source-tenant Exchange objects
- **METHOD** *(VCALENDAR level)*: Prevents Exchange treating the create as a meeting invite or cancellation

**Modified Properties:**
- **UID**: Regenerated as UUIDv4 (bypasses Microsoft's UID rewriting)
- **CATEGORIES**: Set to "CALENDAR-SYNC-MANAGED" (for identification)
- **CLASS**: Set to `PRIVATE` — Exchange/M365 shows this as "Private Appointment" (no title/details to other users); Google Calendar marks it as "Private" visibility

### Skipped Events

The following events are silently skipped (not synced, no error counted):

- **Cancelled events** (`STATUS:CANCELLED`): No longer block time; Exchange rejects creating them as new items.
- **Transparent / free-time events** (`TRANSP:TRANSPARENT`): The event does not mark the user as busy, so it should not appear as a busy block in the personal calendar.
- **Declined recurring instances**: When you decline a specific occurrence of a recurring series, Exchange represents this by (a) adding the declined date to the master VEVENT's `EXDATE` list and (b) creating an exception VEVENT with the same UID, `RECURRENCE-ID`, and `SUMMARY` prefixed with `"Declined:"`. Exchange does **not** set `TRANSP:TRANSPARENT` on these exception VEVENTs. The tool detects them by checking that the exception's `RECURRENCE-ID` date appears in the master's `EXDATE` list *and* the exception's `DTSTART` falls on the same date (which distinguishes declined instances from genuinely rescheduled ones, which have a different `DTSTART`). The master VEVENT is synced normally — its `EXDATE` already suppresses the declined occurrence in the personal calendar.
- **Empty recurring series**: Recurring events where every occurrence is excluded by `EXDATE` (the series expands to zero valid instances). Exchange cannot create a series with no occurrences.

### Personal → Work Sanitization
Events synced from personal to work calendar (maximum privacy):

**Retained Properties:**
- **DTSTART**: Start date/time
- **DTEND**: End date/time
- **RRULE**: Recurrence rules
- **EXDATE**: Recurrence exceptions
- **RDATE**: Additional recurrence dates

**Stripped/Modified:**
- **SUMMARY**: Replaced with "Busy" (title removed for privacy)
- All other properties stripped as per work→personal sanitization above

## Metadata Tagging

Events created by this tool are tagged with:
```
CATEGORIES: CALENDAR-SYNC-MANAGED
```

This allows:
- **Safe refresh**: Tool can identify which events it created
- **Safe clear**: Remove only managed events, preserve others
- **State recovery**: Works even if state database is lost

**Note**: Microsoft 365 preserves CATEGORIES but strips X-properties and COMMENT fields.

## State Database

The sync state is stored in:
```
~/.local/share/eds-calendar-sync-state.db
```

This SQLite database tracks:
- Mapping between work and personal event UIDs
- Content hashes for both events (separate hashes for sanitized versions)
- Event origin ('source' for work events, 'target' for personal events)
- Sync timestamps

**Schema:**
```sql
CREATE TABLE sync_state (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_uid TEXT NOT NULL,        -- Work event UID (or UID::RID::date for recurring exceptions)
    target_uid TEXT NOT NULL,        -- Personal calendar event UID
    source_hash TEXT NOT NULL,       -- Work event content hash
    target_hash TEXT NOT NULL,       -- Personal event content hash (sanitized)
    origin TEXT NOT NULL,            -- 'source' or 'target'
    created_at INTEGER NOT NULL,     -- Unix timestamp
    last_sync_at INTEGER NOT NULL,   -- Unix timestamp
    UNIQUE(source_uid, target_uid)
);
```

**To reset the state** (forces full resync):
```bash
rm ~/.local/share/eds-calendar-sync-state.db
./eds-calendar-sync.py --work-calendar WORK_UID --personal-calendar PERSONAL_UID --yes
```

Or use `--refresh` which safely removes synced events first.

## Troubleshooting

### Calendar Not Found

```
Error: Calendar with UID 'xxx' not found in EDS
```

**Solution**: Run `./list-calendars.py` to verify the UID and ensure the calendar is enabled.

### Permission Errors

```
Error: Failed to connect to calendar
```

**Solution**: Ensure Evolution Data Server is running and your accounts are properly configured in GNOME Calendar or Evolution.

### Calendar Not Writable

```
Error: Read-only calendars can't be modified
```

**Solution**: Verify that your calendar is not read-only. Check with `./list-calendars.py`. Some calendars (like "Birthdays") are read-only.

### Duplicate Categories Error

```
Error: Duplicate category entries
```

This was a bug fixed in v1.0. Update to latest version. The fix ensures existing CATEGORIES are removed before adding the sync marker.

### Spurious Modifications

If sync keeps showing "Modified: N" when nothing changed, this was a bug fixed in v1.0. The tool now correctly tracks separate hashes for work and personal events.

### Cannot Prompt in Non-Interactive Mode

```
Error: Cannot prompt for confirmation in non-interactive mode. Use --yes to proceed.
```

**Solution**: Add `--yes` flag when running from scripts or systemd:
```bash
./eds-calendar-sync.py --work-calendar UID --personal-calendar UID --yes
```

### Systemd Service Fails

```bash
# Check detailed error
systemctl --user status eds-calendar-sync.service
journalctl --user -u eds-calendar-sync.service -n 100

# Common issues:
# 1. Missing --yes flag - required for automation
# 2. Wrong ExecStart path - edit ~/.config/systemd/user/eds-calendar-sync.service
# 3. Config file missing - ensure ~/.config/eds-calendar-sync.conf exists
# 4. EDS not running - check GNOME Calendar is set up
```

### Exchange/M365 Create Errors

If you see errors like:

```
ERROR: Failed to create event ...: e-m365-error-quark: Cannot create calendar object: ErrorItemNotFound (2)
ERROR: Failed to create event ...: ExpandSeries can only be performed against a series. (400)
```

These are Exchange-specific rejections. Common causes and what the tool does automatically:

| Exchange Error | Cause | Handling |
|---|---|---|
| `ExpandSeries can only be performed against a series` | RECURRENCE-ID present (exception occurrence without master series in target) | Stripped from sanitized event |
| `ErrorItemNotFound` (create) | `STATUS:CANCELLED`, empty RRULE+EXDATE series, or vendor X-properties referencing source-tenant objects | STATUS stripped; cancelled and empty-series events skipped |

If errors persist, run with `--verbose` — the full sanitized iCal is printed at `WARNING` level for any failed event, showing exactly which remaining property is causing the rejection.

### Verbose Debugging

Run with `--verbose` to see detailed operations:
```bash
./eds-calendar-sync.py --work-calendar UID --personal-calendar UID --verbose --dry-run
```

## Architecture

```
┌─────────────────┐         ┌──────────────────┐
│  Work Exchange  │◄────────│   EDS Work       │
│   (Microsoft)   │  Sync   │  Calendar Cache  │
└─────────────────┘         └────────┬─────────┘
                                     │
                         Bidirectional Sync
                         (with sanitization)
                                     │
                            ┌────────▼────────┐
                            │  calendar-sync  │
                            │   Python Tool   │
                            │  (with state)   │
                            └────────┬────────┘
                                     │
                         Bidirectional Sync
                         (with sanitization)
                                     │
                            ┌────────▼────────┐         ┌─────────────────┐
                            │  EDS Personal   │────────►│ Personal Google │
                            │ Calendar Cache  │  Sync   │    Calendar     │
                            └─────────────────┘         └─────────────────┘

                            ┌────────────────┐
                            │  SQLite State  │
                            │    Database    │
                            │ + Event Hashes │
                            └────────────────┘
```

**Sync Behavior:**
- **Work → Personal**: Keeps titles, strips details, adds sync marker
- **Personal → Work**: Replaces title with "Busy", strips everything, adds sync marker
- **Loop Prevention**: Tracks separate hashes for both calendars
- **Change Detection**: Only syncs when authoritative calendar changes
- **Metadata Tracking**: CATEGORIES property identifies managed events

## Security Considerations

- **No Network Access**: Tool operates entirely on local EDS cache
- **No Credentials**: Uses existing GNOME Online Accounts authentication
- **Privacy by Default**: Strips all potentially sensitive metadata
- **Configurable Privacy**: Personal→Work events show only "Busy"
- **State Database**: Contains only UIDs and hashes, no event content
- **Safe Operations**: Only modifies events created by this tool
- **Confirmation Prompt**: Prevents accidental syncs (bypass with --yes)

## License

This tool is provided as-is for personal use. Modify as needed for your environment.

## Contributing

Contributions welcome! Please:
1. Test thoroughly before submitting changes
2. Update README for new features
3. Follow existing code style

## See Also

- [Evolution Data Server Documentation](https://wiki.gnome.org/Projects/Evolution)
- [GNOME Calendar](https://wiki.gnome.org/Apps/Calendar)
- [iCalendar RFC 5545](https://tools.ietf.org/html/rfc5545)
